name: Spring Boot CI/CD to EC2 (Ubuntu)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“ Checkout Repository
      uses: actions/checkout@v3

    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: ğŸ› ï¸ Build with Gradle
      run: ./gradlew clean build -x test

    - name: ğŸ“¦ SCP JAR to EC2
      uses: appleboy/scp-action@v0.1.6
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        source: "build/libs"
        target: "/home/${{ secrets.EC2_USER }}/app/"
        strip_components: 2

    - name: ğŸš€ SSH and Run on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.EC2_KEY }}
        script: |
          cd ~/app
          echo "ğŸ“‚ í˜„ì¬ ë””ë ‰í† ë¦¬ ìƒíƒœ:"
          ls -al

          JAR_NAME=$(find . -name "*.jar" | grep -v 'plain' | head -n 1 | sed 's|./||')

          if [ -z "$JAR_NAME" ]; then
            echo "âŒ .jar íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "ğŸ“¦ ì´ì „ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì¤‘..."
          if pgrep -f 'java -jar'; then
            pkill -f 'java -jar' || true
            echo "ğŸ” ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¢…ë£Œ ì™„ë£Œ"
          else
            echo "âœ… ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
          fi

          echo "ğŸš€ $JAR_NAME ì‹¤í–‰ ì¤‘..."
          nohup java -jar $JAR_NAME > app.log 2>&1 & || true
