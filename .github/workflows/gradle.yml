name: Spring Boot CI/CD to EC2 (Ubuntu)

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 📁 Checkout Repository
        uses: actions/checkout@v3

      - name: ☕ Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: 🛠️ Build with Gradle
        run: ./gradlew clean build -x test

      - name: 📦 SCP JAR to EC2
        uses: appleboy/scp-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          source: "build/libs"
          target: "/home/${{ secrets.EC2_USER }}/app/"
          strip_components: 2

      - name: 🚀 SSH and Run on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd ~/app
            echo "📂 현재 디렉토리 상태:"
            ls -al

            JAR_NAME=$(find . -name "*.jar" | grep -v 'plain' | head -n 1 | sed 's|./||')

            if [ -z "$JAR_NAME" ]; then
              echo "❌ .jar 파일을 찾을 수 없습니다!"
              exit 1
            fi

            echo "📦 이전 프로세스 종료 중..."
            if pgrep -f 'java -jar'; then
              pkill -f 'java -jar'
              echo "🔁 기존 프로세스 종료 완료"
            else
              echo "✅ 실행 중인 프로세스 없음"
            fi

            echo "🚀 $JAR_NAME 실행 중..."
            nohup java -jar $JAR_NAME > app.log 2>&1 &

            echo "✅ 배포 완료!"
            exit 0
